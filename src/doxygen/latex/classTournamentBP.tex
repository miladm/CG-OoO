\hypertarget{classTournamentBP}{
\section{TournamentBP Class Reference}
\label{classTournamentBP}\index{TournamentBP@{TournamentBP}}
}


{\ttfamily \#include $<$tournament.h$>$}

\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct {\bfseries BPHistory}
\end{DoxyCompactItemize}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classTournamentBP_a139b9b75152644b3b9359290140458a0}{TournamentBP} (unsigned localPredictorSize, unsigned localCtrBits, unsigned localHistoryTableSize, unsigned localHistoryBits, unsigned globalPredictorSize, unsigned globalHistoryBits, unsigned globalCtrBits, unsigned choicePredictorSize, unsigned choiceCtrBits, unsigned instShiftAmt)
\item 
bool \hyperlink{classTournamentBP_a493edbed2253cdfcda936f4dcda80df0}{lookup} (Addr \&branch\_\-addr, void $\ast$\&bp\_\-history)
\item 
void \hyperlink{classTournamentBP_a7326c97464700d2ade3996ccf0d8d4b4}{uncondBr} (void $\ast$\&bp\_\-history)
\item 
void \hyperlink{classTournamentBP_a58d163a5d49b0c7313dbaffd3738283e}{BTBUpdate} (Addr \&branch\_\-addr, void $\ast$\&bp\_\-history)
\item 
void \hyperlink{classTournamentBP_a3c4515cdaf3778811b03b74bf381a3f8}{update} (Addr \&branch\_\-addr, bool taken, void $\ast$bp\_\-history, bool squashed)
\item 
void \hyperlink{classTournamentBP_acf02d96a4a353442c055d3109e1bf1d2}{squash} (void $\ast$bp\_\-history)
\item 
unsigned \hyperlink{classTournamentBP_a09794f569c803909afa2677e16b993f4}{readGlobalHist} ()
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Implements a tournament branch predictor, hopefully identical to the one used in the 21264. It has a local predictor, which uses a local history table to index into a table of counters, and a global predictor, which uses a global history to index into a table of counters. A choice predictor chooses between the two. Only the global history register is speculatively updated, the rest are updated upon branches committing or misspeculating. 

\subsection{Constructor \& Destructor Documentation}
\hypertarget{classTournamentBP_a139b9b75152644b3b9359290140458a0}{
\index{TournamentBP@{TournamentBP}!TournamentBP@{TournamentBP}}
\index{TournamentBP@{TournamentBP}!TournamentBP@{TournamentBP}}
\subsubsection[{TournamentBP}]{\setlength{\rightskip}{0pt plus 5cm}TournamentBP::TournamentBP (
\begin{DoxyParamCaption}
\item[{unsigned}]{localPredictorSize, }
\item[{unsigned}]{localCtrBits, }
\item[{unsigned}]{localHistoryTableSize, }
\item[{unsigned}]{localHistoryBits, }
\item[{unsigned}]{globalPredictorSize, }
\item[{unsigned}]{globalHistoryBits, }
\item[{unsigned}]{globalCtrBits, }
\item[{unsigned}]{choicePredictorSize, }
\item[{unsigned}]{choiceCtrBits, }
\item[{unsigned}]{instShiftAmt}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_a139b9b75152644b3b9359290140458a0}
Default branch predictor constructor. 
\begin{DoxyCode}
    : localPredictorSize(_localPredictorSize),
      localCtrBits(_localCtrBits),
      localHistoryTableSize(_localHistoryTableSize),
      localHistoryBits(_localHistoryBits),
      globalPredictorSize(_globalPredictorSize),
      globalCtrBits(_globalCtrBits),
      globalHistoryBits(_globalHistoryBits),
      choicePredictorSize(_globalPredictorSize),
      choiceCtrBits(_choiceCtrBits),
      instShiftAmt(_instShiftAmt)
{
    if (!isPowerOf2(localPredictorSize)) {
        fatal("Invalid local predictor size!\n");
    }

    //Setup the array of counters for the local predictor
    localCtrs.resize(localPredictorSize);

    for (int i = 0; i < localPredictorSize; ++i)
        localCtrs[i].setBits(localCtrBits);

    localPredictorMask = floorPow2(localPredictorSize) - 1;

    if (!isPowerOf2(localHistoryTableSize)) {
        fatal("Invalid local history table size!\n");
    }

    //Setup the history table for the local table
    localHistoryTable.resize(localHistoryTableSize);

    for (int i = 0; i < localHistoryTableSize; ++i)
        localHistoryTable[i] = 0;

    // Setup the local history mask
    localHistoryMask = (1 << localHistoryBits) - 1;

    if (!isPowerOf2(globalPredictorSize)) {
        fatal("Invalid global predictor size!\n");
    }

    //Setup the array of counters for the global predictor
    globalCtrs.resize(globalPredictorSize);

    for (int i = 0; i < globalPredictorSize; ++i)
        globalCtrs[i].setBits(globalCtrBits);

    //Clear the global history
    globalHistory = 0;
    // Setup the global history mask
    globalHistoryMask = (1 << globalHistoryBits) - 1;

    if (!isPowerOf2(choicePredictorSize)) {
        fatal("Invalid choice predictor size!\n");
    }

    //Setup the array of counters for the choice predictor
    choiceCtrs.resize(choicePredictorSize);

    for (int i = 0; i < choicePredictorSize; ++i)
        choiceCtrs[i].setBits(choiceCtrBits);

    // @todo: Allow for different thresholds between the predictors.
    threshold = (1 << (localCtrBits - 1)) - 1;
}
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classTournamentBP_a58d163a5d49b0c7313dbaffd3738283e}{
\index{TournamentBP@{TournamentBP}!BTBUpdate@{BTBUpdate}}
\index{BTBUpdate@{BTBUpdate}!TournamentBP@{TournamentBP}}
\subsubsection[{BTBUpdate}]{\setlength{\rightskip}{0pt plus 5cm}void TournamentBP::BTBUpdate (
\begin{DoxyParamCaption}
\item[{Addr \&}]{branch\_\-addr, }
\item[{void $\ast$\&}]{bp\_\-history}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_a58d163a5d49b0c7313dbaffd3738283e}
Updates the branch predictor to Not Taken if a BTB entry is invalid or not found. 
\begin{DoxyParams}{Parameters}
{\em branch\_\-addr} & The address of the branch to look up. \\
\hline
{\em bp\_\-history} & Pointer to any bp history state. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Whether or not the branch is taken. 
\end{DoxyReturn}

\begin{DoxyCode}
{
    unsigned local_history_idx = calcLocHistIdx(branch_addr);
    //Update Global History to Not Taken
    globalHistory = globalHistory & (globalHistoryMask - 1);
    //Update Local History to Not Taken
    localHistoryTable[local_history_idx] =
       localHistoryTable[local_history_idx] & (localPredictorMask - 1);
}
\end{DoxyCode}
\hypertarget{classTournamentBP_a493edbed2253cdfcda936f4dcda80df0}{
\index{TournamentBP@{TournamentBP}!lookup@{lookup}}
\index{lookup@{lookup}!TournamentBP@{TournamentBP}}
\subsubsection[{lookup}]{\setlength{\rightskip}{0pt plus 5cm}bool TournamentBP::lookup (
\begin{DoxyParamCaption}
\item[{Addr \&}]{branch\_\-addr, }
\item[{void $\ast$\&}]{bp\_\-history}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_a493edbed2253cdfcda936f4dcda80df0}
Looks up the given address in the branch predictor and returns a true/false value as to whether it is taken. Also creates a BPHistory object to store any state it will need on squash/update. 
\begin{DoxyParams}{Parameters}
{\em branch\_\-addr} & The address of the branch to look up. \\
\hline
{\em bp\_\-history} & Pointer that will be set to the BPHistory object. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Whether or not the branch is taken. 
\end{DoxyReturn}

\begin{DoxyCode}
{
    bool local_prediction;
    unsigned local_history_idx;
    unsigned local_predictor_idx;

    bool global_prediction;
    bool choice_prediction;

    //Lookup in the local predictor to get its branch prediction
    local_history_idx = calcLocHistIdx(branch_addr);
    local_predictor_idx = localHistoryTable[local_history_idx]
        & localPredictorMask;
    local_prediction = localCtrs[local_predictor_idx].read() > threshold;

    //Lookup in the global predictor to get its branch prediction
    global_prediction = globalCtrs[globalHistory].read() > threshold;

    //Lookup in the choice predictor to see which one to use
    choice_prediction = choiceCtrs[globalHistory].read() > threshold;

    // Create BPHistory and pass it back to be recorded.
    BPHistory *history = new BPHistory;
    history->globalHistory = globalHistory;
    history->localPredTaken = local_prediction;
    history->globalPredTaken = global_prediction;
    history->globalUsed = choice_prediction;
    history->localHistory = local_predictor_idx;
    bp_history = (void *)history;

    assert(globalHistory < globalPredictorSize &&
           local_history_idx < localHistoryTableSize &&
           local_predictor_idx < localPredictorSize);

    // Commented code is for doing speculative update of counters and
    // all histories.
    if (choice_prediction) {
        if (global_prediction) {
            updateGlobalHistTaken();
            updateLocalHistTaken(local_history_idx);
            return true;
        } else {
            updateGlobalHistNotTaken();
            updateLocalHistNotTaken(local_history_idx);
            return false;
        }
    } else {
        if (local_prediction) {
            updateGlobalHistTaken();
            updateLocalHistTaken(local_history_idx);
            return true;
        } else {
            updateGlobalHistNotTaken();
            updateLocalHistNotTaken(local_history_idx);
            return false;
        }
    }
}
\end{DoxyCode}
\hypertarget{classTournamentBP_a09794f569c803909afa2677e16b993f4}{
\index{TournamentBP@{TournamentBP}!readGlobalHist@{readGlobalHist}}
\index{readGlobalHist@{readGlobalHist}!TournamentBP@{TournamentBP}}
\subsubsection[{readGlobalHist}]{\setlength{\rightskip}{0pt plus 5cm}unsigned TournamentBP::readGlobalHist (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}inline\mbox{]}}}}
\label{classTournamentBP_a09794f569c803909afa2677e16b993f4}
Returns the global history. 
\begin{DoxyCode}
{ return globalHistory; }
\end{DoxyCode}
\hypertarget{classTournamentBP_acf02d96a4a353442c055d3109e1bf1d2}{
\index{TournamentBP@{TournamentBP}!squash@{squash}}
\index{squash@{squash}!TournamentBP@{TournamentBP}}
\subsubsection[{squash}]{\setlength{\rightskip}{0pt plus 5cm}void TournamentBP::squash (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{bp\_\-history}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_acf02d96a4a353442c055d3109e1bf1d2}
Restores the global branch history on a squash. 
\begin{DoxyParams}{Parameters}
{\em bp\_\-history} & Pointer to the BPHistory object that has the previous global branch history in it. \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
{
    BPHistory *history = static_cast<BPHistory *>(bp_history);

    // Restore global history to state prior to this branch.
    globalHistory = history->globalHistory;

    // Delete this BPHistory now that we're done with it.
    delete history;
}
\end{DoxyCode}
\hypertarget{classTournamentBP_a7326c97464700d2ade3996ccf0d8d4b4}{
\index{TournamentBP@{TournamentBP}!uncondBr@{uncondBr}}
\index{uncondBr@{uncondBr}!TournamentBP@{TournamentBP}}
\subsubsection[{uncondBr}]{\setlength{\rightskip}{0pt plus 5cm}void TournamentBP::uncondBr (
\begin{DoxyParamCaption}
\item[{void $\ast$\&}]{bp\_\-history}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_a7326c97464700d2ade3996ccf0d8d4b4}
Records that there was an unconditional branch, and modifies the bp history to point to an object that has the previous global history stored in it. 
\begin{DoxyParams}{Parameters}
{\em bp\_\-history} & Pointer that will be set to the BPHistory object. \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
{
    // Create BPHistory and pass it back to be recorded.
    BPHistory *history = new BPHistory;
    history->globalHistory = globalHistory;
    history->localPredTaken = true;
    history->globalPredTaken = true;
    history->globalUsed = true;
    history->localHistory = invalidPredictorIndex;
    bp_history = static_cast<void *>(history);

    updateGlobalHistTaken();
}
\end{DoxyCode}
\hypertarget{classTournamentBP_a3c4515cdaf3778811b03b74bf381a3f8}{
\index{TournamentBP@{TournamentBP}!update@{update}}
\index{update@{update}!TournamentBP@{TournamentBP}}
\subsubsection[{update}]{\setlength{\rightskip}{0pt plus 5cm}void TournamentBP::update (
\begin{DoxyParamCaption}
\item[{Addr \&}]{branch\_\-addr, }
\item[{bool}]{taken, }
\item[{void $\ast$}]{bp\_\-history, }
\item[{bool}]{squashed}
\end{DoxyParamCaption}
)}}
\label{classTournamentBP_a3c4515cdaf3778811b03b74bf381a3f8}
Updates the branch predictor with the actual result of a branch. 
\begin{DoxyParams}{Parameters}
{\em branch\_\-addr} & The address of the branch to update. \\
\hline
{\em taken} & Whether or not the branch was taken. \\
\hline
{\em bp\_\-history} & Pointer to the BPHistory object that was created when the branch was predicted. \\
\hline
{\em squashed} & is set when this function is called during a squash operation. \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
{
    unsigned local_history_idx;
    unsigned local_predictor_idx M5_VAR_USED;
    unsigned local_predictor_hist;

    // Get the local predictor's current prediction
    local_history_idx = calcLocHistIdx(branch_addr);
    local_predictor_hist = localHistoryTable[local_history_idx];
    local_predictor_idx = local_predictor_hist & localPredictorMask;

    if (bp_history) {
        BPHistory *history = static_cast<BPHistory *>(bp_history);
        // Update may also be called if the Branch target is incorrect even if
        // the prediction is correct. In that case do not update the counters.
        bool historyPred = false;
        unsigned old_local_pred_index = history->localHistory
                      & localPredictorMask;
        if (history->globalUsed) {
           historyPred = history->globalPredTaken;
        } else {
           historyPred = history->localPredTaken;
        }
        if (historyPred != taken || !squashed) {
            // Update the choice predictor to tell it which one was correct if
            // there was a prediction.
            if (history->localPredTaken != history->globalPredTaken) {
                 // If the local prediction matches the actual outcome,
                 // decerement the counter.  Otherwise increment the
                 // counter.
                 if (history->localPredTaken == taken) {
                     choiceCtrs[history->globalHistory].decrement();
                 } else if (history->globalPredTaken == taken) {
                     choiceCtrs[history->globalHistory].increment();
                 }

             }

             // Update the counters and local history with the proper
             // resolution of the branch.  Global history is updated
             // speculatively and restored upon squash() calls, so it does not
             // need to be updated.
             if (taken) {
                  globalCtrs[history->globalHistory].increment();
                  if (old_local_pred_index != invalidPredictorIndex) {
                          localCtrs[old_local_pred_index].increment();
                  }
             } else {
                  globalCtrs[history->globalHistory].decrement();
                  if (old_local_pred_index != invalidPredictorIndex) {
                          localCtrs[old_local_pred_index].decrement();
                  }
             }
        }
        if (squashed) {
             if (taken) {
                globalHistory = (history->globalHistory << 1) | 1;
                globalHistory = globalHistory & globalHistoryMask;
                if (old_local_pred_index != invalidPredictorIndex) {
                    localHistoryTable[old_local_pred_index] =
                     (history->localHistory << 1) | 1;
                }
             } else {
                globalHistory = (history->globalHistory << 1);
                globalHistory = globalHistory & globalHistoryMask;
                if (old_local_pred_index != invalidPredictorIndex) {
                     localHistoryTable[old_local_pred_index] =
                     history->localHistory << 1;
                }
             }

        }
        // We're done with this history, now delete it.
        delete history;

    }

    assert(globalHistory < globalPredictorSize &&
           local_history_idx < localHistoryTableSize &&
           local_predictor_idx < localPredictorSize);


}
\end{DoxyCode}


The documentation for this class was generated from the following files:\begin{DoxyCompactItemize}
\item 
/home/milad/esc\_\-project/svn/PARS/src/forLater/pred/\hyperlink{tournament_8h}{tournament.h}\item 
/home/milad/esc\_\-project/svn/PARS/src/forLater/pred/\hyperlink{forLater_2pred_2tournament_8cpp}{tournament.cpp}\item 
/home/milad/esc\_\-project/svn/PARS/src/frontend/\hyperlink{frontend_2tournament_8cpp}{tournament.cpp}\end{DoxyCompactItemize}
